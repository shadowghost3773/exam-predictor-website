<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Exam Predictor - Working Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7ff;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .upload-area {
            border: 3px dashed var(--accent);
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: rgba(67, 97, 238, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .file-item {
            background: var(--light);
            padding: 0.8rem 1.2rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .progress-container {
            margin: 2rem 0;
        }
        
        .progress-bar {
            height: 12px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }
        
        .real-results {
            margin: 2rem 0;
        }
        
        .question-item {
            background: var(--light);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .probability {
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .analysis-log {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 0.3rem 0;
            color: #495057;
        }
        
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Real Exam Predictor</div>
        </div>
    </header>

    <div class="container">
        <div class="upload-section">
            <h2>Upload Real Question Papers</h2>
            <p>Upload images of previous exams. The system will ACTUALLY analyze them and find patterns.</p>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Drag & Drop or Click to Upload</h3>
                <p>Supported: JPG, PNG images of question papers</p>
                <input type="file" class="file-input" id="fileInput" accept="image/*" multiple>
            </div>
            
            <div class="uploaded-files" id="uploadedFiles"></div>
            
            <div style="text-align: center;">
                <button class="btn" id="analyzeBtn" disabled>
                    <span id="btnText">Analyze Papers</span>
                </button>
            </div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2>Real Analysis Results</h2>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="analysisProgress"></div>
                </div>
                <div id="progressText">Ready to analyze...</div>
            </div>
            
            <div class="analysis-log" id="analysisLog">
                <div class="log-entry">System ready. Upload papers to begin analysis.</div>
            </div>
            
            <div class="real-results" id="realResults">
                <!-- REAL results will appear here -->
            </div>
        </div>
    </div>

    <script>
        // REAL WORKING ANALYSIS ENGINE
        class RealExamAnalyzer {
            constructor() {
                this.uploadedPapers = [];
                this.analyzedQuestions = [];
                this.questionPatterns = {};
                this.worker = null;
            }

            async processImage(file) {
                this.addLog(`Processing: ${file.name}`, 'warning');
                
                try {
                    // Initialize Tesseract worker
                    if (!this.worker) {
                        this.worker = await Tesseract.createWorker('eng');
                    }
                    
                    // Perform OCR
                    const { data: { text } } = await this.worker.recognize(file);
                    
                    this.addLog(`Extracted text from ${file.name}`, 'success');
                    return this.analyzeText(text, file.name);
                    
                } catch (error) {
                    this.addLog(`Error processing ${file.name}: ${error.message}`, 'error');
                    return [];
                }
            }

            analyzeText(text, filename) {
                const questions = [];
                const lines = text.split('\n').filter(line => line.trim());
                
                // REAL pattern matching for questions
                lines.forEach((line, index) => {
                    const trimmed = line.trim();
                    
                    // Look for question patterns
                    if (this.isLikelyQuestion(trimmed)) {
                        const question = {
                            text: trimmed,
                            source: filename,
                            lineNumber: index + 1,
                            keywords: this.extractKeywords(trimmed),
                            type: this.detectQuestionType(trimmed),
                            marks: this.extractMarks(trimmed)
                        };
                        
                        if (question.text.length > 10) { // Filter out very short lines
                            questions.push(question);
                        }
                    }
                });
                
                this.addLog(`Found ${questions.length} potential questions in ${filename}`, 'success');
                return questions;
            }

            isLikelyQuestion(text) {
                // REAL heuristics to identify questions
                const questionIndicators = [
                    /^\d+[\.\)]\s/, // Numbered items: "1.", "2)"
                    /[?]$/, // Ends with question mark
                    /(explain|describe|define|calculate|prove|solve|state|what|how|why)/i,
                    /(marks|mark)\s*\d+/i,
                    /^\s*[A-Z][^a-z]*$/ // All caps (often section headers)
                ];
                
                return questionIndicators.some(pattern => pattern.test(text));
            }

            extractKeywords(text) {
                // Simple keyword extraction
                const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by']);
                const words = text.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !stopWords.has(word));
                
                return [...new Set(words)]; // Remove duplicates
            }

            detectQuestionType(text) {
                if (text.includes('?') || /(what|how|why|when|where)/i.test(text)) {
                    return 'Descriptive';
                }
                if (/(calculate|solve|find|prove)/i.test(text)) {
                    return 'Numerical';
                }
                if (/(explain|describe|define)/i.test(text)) {
                    return 'Explanatory';
                }
                if (/(state|list|name)/i.test(text)) {
                    return 'Short Answer';
                }
                return 'Unknown';
            }

            extractMarks(text) {
                const markMatch = text.match(/(\d+)\s*marks?/i);
                return markMatch ? parseInt(markMatch[1]) : null;
            }

            analyzePatterns(allQuestions) {
                this.addLog('Analyzing question patterns across all papers...', 'warning');
                
                const frequencyMap = {};
                const keywordFrequency = {};
                
                // Count question frequencies
                allQuestions.forEach(q => {
                    const key = q.text.substring(0, 100).toLowerCase(); // Use first 100 chars as key
                    frequencyMap[key] = (frequencyMap[key] || 0) + 1;
                    
                    // Count keyword frequencies
                    q.keywords.forEach(keyword => {
                        keywordFrequency[keyword] = (keywordFrequency[keyword] || 0) + 1;
                    });
                });
                
                // Calculate probabilities
                const totalPapers = this.uploadedPapers.length;
                const predictions = [];
                
                Object.entries(frequencyMap).forEach(([questionText, frequency]) => {
                    const probability = Math.min(95, (frequency / totalPapers) * 100);
                    const originalQuestion = allQuestions.find(q => 
                        q.text.toLowerCase().includes(questionText.substring(0, 50))
                    );
                    
                    if (originalQuestion && probability >= 20) {
                        predictions.push({
                            text: originalQuestion.text,
                            probability: Math.round(probability),
                            frequency: frequency,
                            type: originalQuestion.type,
                            marks: originalQuestion.marks,
                            sources: allQuestions.filter(q => 
                                q.text.toLowerCase().includes(questionText.substring(0, 50))
                            ).map(q => q.source)
                        });
                    }
                });
                
                // Sort by probability
                predictions.sort((a, b) => b.probability - a.probability);
                
                this.addLog(`Generated ${predictions.length} predictions based on actual patterns`, 'success');
                return predictions;
            }

            addLog(message, type = '') {
                const log = document.getElementById('analysisLog');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type ? 'log-' + type : ''}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            async cleanup() {
                if (this.worker) {
                    await this.worker.terminate();
                    this.worker = null;
                }
            }
        }

        // Initialize the real analyzer
        const analyzer = new RealExamAnalyzer();

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisSection = document.getElementById('analysisSection');
        const analysisProgress = document.getElementById('analysisProgress');
        const progressText = document.getElementById('progressText');
        const realResults = document.getElementById('realResults');
        const btnText = document.getElementById('btnText');

        let uploadedFilesList = [];

        // Upload functionality
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(67, 97, 238, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    alert('Please upload only image files (JPG, PNG)');
                    continue;
                }
                
                uploadedFilesList.push(file);
                analyzer.uploadedPapers.push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    üìÑ ${file.name}
                    <span class="remove" onclick="removeFile('${file.name}')">‚úï</span>
                `;
                uploadedFiles.appendChild(fileItem);
            }
            
            // Enable analyze button if we have files
            analyzeBtn.disabled = uploadedFilesList.length === 0;
            if (uploadedFilesList.length > 0) {
                btnText.textContent = `Analyze ${uploadedFilesList.length} Paper${uploadedFilesList.length > 1 ? 's' : ''}`;
            }
        }

        function removeFile(filename) {
            uploadedFilesList = uploadedFilesList.filter(f => f.name !== filename);
            analyzer.uploadedPapers = analyzer.uploadedPapers.filter(f => f.name !== filename);
            
            // Refresh file display
            uploadedFiles.innerHTML = '';
            uploadedFilesList.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    üìÑ ${file.name}
                    <span class="remove" onclick="removeFile('${file.name}')">‚úï</span>
                `;
                uploadedFiles.appendChild(fileItem);
            });
            
            analyzeBtn.disabled = uploadedFilesList.length === 0;
            btnText.textContent = `Analyze ${uploadedFilesList.length} Paper${uploadedFilesList.length > 1 ? 's' : ''}`;
        }

        // Global function for removal
        window.removeFile = removeFile;

        // Analysis button
        analyzeBtn.addEventListener('click', async function() {
            if (uploadedFilesList.length === 0) return;
            
            // Show analysis section
            analysisSection.style.display = 'block';
            analyzeBtn.disabled = true;
            btnText.textContent = 'Analyzing...';
            
            // Clear previous results
            realResults.innerHTML = '';
            document.getElementById('analysisLog').innerHTML = 
                '<div class="log-entry">Starting real analysis...</div>';
            
            try {
                let allExtractedQuestions = [];
                let processedCount = 0;
                
                // Process each file
                for (let file of uploadedFilesList) {
                    analyzer.addLog(`Processing: ${file.name}`, 'warning');
                    
                    // Update progress
                    const progress = ((processedCount / uploadedFilesList.length) * 100).toFixed(0);
                    analysisProgress.style.width = `${progress}%`;
                    progressText.textContent = `Processing ${file.name}...`;
                    
                    // Real OCR processing
                    const questions = await analyzer.processImage(file);
                    allExtractedQuestions = allExtractedQuestions.concat(questions);
                    processedCount++;
                }
                
                analyzer.addLog(`Total questions extracted: ${allExtractedQuestions.length}`, 'success');
                
                // Analyze patterns
                progressText.textContent = 'Analyzing patterns...';
                analysisProgress.style.width = '80%';
                
                const predictions = analyzer.analyzePatterns(allExtractedQuestions);
                
                // Display real results
                progressText.textContent = 'Generating final predictions...';
                analysisProgress.style.width = '100%';
                
                displayRealResults(predictions);
                
                progressText.textContent = `Analysis complete! Processed ${uploadedFilesList.length} papers, found ${allExtractedQuestions.length} questions`;
                analyzer.addLog('Analysis completed successfully', 'success');
                
            } catch (error) {
                analyzer.addLog(`Analysis failed: ${error.message}`, 'error');
                progressText.textContent = 'Analysis failed - check console for details';
            } finally {
                analyzeBtn.disabled = false;
                btnText.textContent = `Re-analyze ${uploadedFilesList.length} Paper${uploadedFilesList.length > 1 ? 's' : ''}`;
                await analyzer.cleanup();
            }
        });

        function displayRealResults(predictions) {
            realResults.innerHTML = '';
            
            if (predictions.length === 0) {
                realResults.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h3>No clear patterns detected</h3>
                        <p>The system couldn't find repeated questions in your uploaded papers.</p>
                        <p>Try uploading more papers or papers with clearer question text.</p>
                    </div>
                `;
                return;
            }
            
            const header = document.createElement('h3');
            header.textContent = `Predicted Questions (Based on ${uploadedFilesList.length} Papers)`;
            realResults.appendChild(header);
            
            predictions.forEach(prediction => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                questionDiv.innerHTML = `
                    <strong>${prediction.text}</strong>
                    <div style="margin-top: 0.5rem;">
                        <span class="probability">${prediction.probability}% likely</span>
                        <span style="margin-left: 1rem; color: #666;">
                            Appeared in ${prediction.frequency} paper${prediction.frequency > 1 ? 's' : ''}
                        </span>
                        ${prediction.marks ? `<span style="margin-left: 1rem; color: #666;">${prediction.marks} marks</span>` : ''}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #888;">
                        Type: ${prediction.type} | 
                        Sources: ${prediction.sources.join(', ')}
                    </div>
                `;
                
                realResults.appendChild(questionDiv);
            });
            
            // Add summary
            const summary = document.createElement('div');
            summary.style.marginTop = '2rem';
            summary.style.padding = '1rem';
            summary.style.background = '#e9ecef';
            summary.style.borderRadius = '8px';
            summary.innerHTML = `
                <strong>Analysis Summary:</strong><br>
                - Processed ${uploadedFilesList.length} question papers<br>
                - Found ${predictions.length} predictable question patterns<br>
                - Most frequent question: ${predictions[0]?.probability}% probability<br>
                - Based on actual OCR text extraction and pattern matching
            `;
            realResults.appendChild(summary);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            analyzer.cleanup();
        });
    </script>
</body>
</html>
